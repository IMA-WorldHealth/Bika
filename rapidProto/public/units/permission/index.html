<html>
    <head>
        <title>USER PERMISSION</title>
        
        <link rel="stylesheet" href="./js/dojoos/dijit/themes/claro/claro.css" media="screen"/>
        <link rel="stylesheet" href="./js/dojoos/gridx/resources/claro/Gridx.css"/> 
        <link rel = "stylesheet" type = "text/css" href="../css/userPermission.css" media="screen" />
        <script>
        require([
         	"customizedModule/UnitsForm",
           "dojo/store/JsonRest",
           "dijit/form/TextBox",
           "dijit/form/CheckBox",
           "dijit/form/Button",
           "dojo/on",
           "dojo/Deferred",
           "dojo/topic",
           "dijit/Dialog",
           "dojo/dom-construct",
           "gridx/core/model/cache/Async",
           "gridx/modules/SingleSort",
           "gridx/Grid",
           "dojo/domReady!"
           ], function (UnitsForm, JsonRest,TextBox,CheckBox, Button, on, Deferred, topic, Dialog, domCons, Cache, SingleSort, Grid){
           	//declarations des variables
           	var bCreer, bAnnuler,bModifier,bSupprimer, txtFirstName, txtLastName, txtEmail,
           	 txtUserName, txtPassWord, txtConformPassWord, chkAdministrator, roleStore,
               userGrid, userStore, roleGridQuery = {}, userGridQuery = {}, 
               crudStore,f, dialog, roleGrid, tabContainerID=[];
               var deferred = new Deferred();

           	  //creations champs des saisies
           	txtFirstName = new TextBox({class:"saisie", style:"width:220px;"},"firstnameID");
           	txtLastName = new TextBox({class:"saisie", style:"width:220px;"},"lastnameID");
           	txtEmail = new TextBox({class:"saisie", style:"width:220px;"},"emailID");
           	txtUserName = new TextBox({class:"saisie", style:"width:220px;"},"usernameID");
           	txtPassWord = new TextBox({class:"saisie", type:"password", style:"width:220px;"},"passwordID");
           	txtConformPassWord = new TextBox({class:"saisie", type:"password", style:"width:220px;"},"confirmpasswordID");

            //creation des boutons
            bCreer = new Button({label:"Creer", onClick:creer}, "creerID");
            bModifier = new Button({label:"Modifier", onClick:modifier}, "modifierID");
            bSupprimer = new Button({label:"Supprimer", onClick:supprimer}, "supprimerID");
            bAnnuler = new Button({label:"Annuler"},"annulerID");
            //stores
            crudStore = new JsonRest({target:'/data/'});
             

             (function(){
              //formulaire pour admin role
              f = new UnitsForm({},"divformdroit");
              var drawTDElements = function(id, roles){
                var node;
                for(var i=0; i<roles.length; i++){
                  tabContainerID.push(roles[i].id);
                  node = domCons.toDom("<td id=\""+roles[i].id+"\" ></td>"); 
                  domCons.place(node,"ligneID");
                }
                console.log('tout va bien');
                deferred.resolve(true);
              }

              var drawDIVElements = function(id, units){
                var node;
                 for(var j=0; j<units.length; j++){                      
                      node = domCons.toDom("<div id=\""+units[j].id+"\"></div><span>"+units[j].name+"</span><br/>");
                      console.log('id est ', id);
                      domCons.place(node,""+id);
                    }
                    f.placeControls(units);
                    deferred = undefined;
              }

              var res = getChild(0, drawTDElements);
              res.then(function(value){
                console.log('nous on commence');
               for(var j=0; j<tabContainerID.length; j++){
                getChild(tabContainerID[j], drawDIVElements);
               }
              });       
            
            })();

            //*********************************************
            //**************LES FONCTIONS******************
            //*********************************************

            var creer = function(){

            }
            var modifier = function(){
              
            }
            var supprimer = function(){
              
            }
            var annuler = function(){
              
            }
            function getChild(id, cb){
             sql={};    
             sql.e = [{t:'unit', c:['id', 'name']}];
             sql.cond = [{t:'unit', cl:'parent', v:id, z:'='}];
             crudStore.query(sql).then(function(data){
              return cb(id, data);
             }); 
             if(deferred)
             return deferred.promise;              
            }
           initUserGrid();        

            function initUserGrid(){
            userStore = new JsonRest({
                        target: '/data/'
                    });

                    var columns = [{
                        id: 'id',
                        field: 'id',
                        name: 'ID'
                    }, {
                        id: 'username',
                        field: 'username',
                        name: 'USER NAME'
                    }, {
                        id: 'email',
                        field: 'email',
                        name: 'EMAIL'
                    }];

                    var e = [{t : 'user', c : ['id', 'username', 'email']}];                    
                    userGridQuery.e = e;
                    var requetteGrid = JSON.stringify(userGridQuery);

                    userGrid = new Grid({
                        style: "height:230px;",
                        cacheClass: Cache,
                        store: userStore,
                        query: '?'+requetteGrid,
                        structure: columns,
                        selectRowTriggerOnCell: true,
                        modules: [
                            SingleSort,
                            ],
                    }, "divuser");
            userGrid.startup(); 
            }  
        });
        </script>      
         

    </head>
    <body class = "claro">
     <div id="principal">
     	<div id="divForm">
     	    <form id="newuserformID">
	            <div><label><b>First Name :</b></label><div class="saisie" id="firstnameID"></div></div>
	            <br/>
	            <div><label><b>Last Name :</b></label><div class="saisie" id="lastnameID"></div></div>
	            <br/>
	            <div><label><b>Email :</b></label><div class="saisie" id="emailID"></div></div>
	            <br/>
	            <span id="spanbademailID"><div id="bademailID"></div></span>
	            <br/>
	            <div><label><b>User Name :</b></label><div  class="saisie" id="usernameID"></div></div>
	            <br/> 
	            <div><label><b>Password :</b></label><div class="saisie" id="passwordID"></div></div>
	            <br/>
	            <div><label><b>Confirm Password :</b></label><div class="saisie" id="confirmpasswordID"></div></div>
	            <br/>
              <span id="spanbadpasswordID"><div id="badpasswordID"></div></span><br/>
          </form>     		
     	</div> 
      <!--cette div contient des bouttons-->     
      <center><div id="divAction">
        <fieldset >
          <legend>Actions</legend>
          <div id="creerID"></div>
          <div id="modifierID"></div>
          <div id="supprimerID"></div>
          <div id="annulerID"></div>
        </fieldset>             		
     	</div></center>
      <!--cette div contient les checks box-->
      <center><div id="divformdroit">
        <fieldset>
          <legend>Droits</legend>
        <form id="droitformID">
          <table>
            <tr id="ligneID">
            </tr>
          </table>
        </form>
      </fieldset>
      </div>   </center> 
      <!-- cette div contient un grid listant les utilisateurs-->
    <div id="divuser"> 
    <fieldset>
      <legend>Users</legend>
    </fieldset>     
    </div>     
    </div>
  </body> 
    
</html>   

