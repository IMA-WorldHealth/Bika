<html>
    <head>
        <title>GRIDX BIKA</title>
        <link rel="stylesheet" href="./js/dojoos/dijit/themes/claro/claro.css" media="screen"/>
        <link rel="stylesheet" href="./js/dojoos/gridx/resources/claro/Gridx.css"/>
        <script src="./js/dojoos/dojo/dojo.js" data-dojo-config="async:true" ></script>
         <script>
            var dojoConfig = {
                //async true causes the HTML to be displayed before executing the javascript - there must be a fix for this
                async: false,
                isDebug: true,
                parseOnLoad: false
              };
        </script>
         <script>
         require(["customizedModule/SelectX",
           "dojo/store/JsonRest",
           "dojo/on",
           "dojo/Deferred",
           "dojo/promise/all",
           "gridx/core/model/cache/Async",
                "gridx/modules/SingleSort",
                "gridx/modules/extendedSelect/Row",
                "gridx/modules/CellWidget",
                "gridx/Grid",
           "dojo/domReady!"
           ], function (SelectX, JsonRest, on, Deferred, all, Cache, SingleSort, Row, CellWidget, Grid) {
            
          // les composants
           var enterpriseSelect;
           var accountSelect;
           var fiscalYearSelect;
           var dateFromSelect, dateToSelect;
           var masterGrid;
           
           //autres
           var IDAccount, dateFrom, dateTo;

           //les query
           var enterpriseSelect_query = {};
           var accountSelect_query = {};
           var fiscalYearSelect_query = {};
           var dateFrom_query = {};
           var dateTo_query = {};
           var grid_query = {}; 
           
           

           var result =  initEnterpriseSelect();
           result.then(function (value) {
              return all({IDAccount : initAccountSelect(value), IDFiscalYear : initFiscalYearSelect(value)});
           }).then(function (result) {
            IDAccount = result.IDAccount;  
            return all({IDAccount : IDAccount,
             dateFrom : getDateFrom(result.IDFiscalYear),
             dateTo : getDateTo(result.IDFiscalYear)});
           }).then(function (result) {
            if(result.IDAccount && result.dateFrom && result.dateTo) {
              initGrid(result);
            }
           });


           //LES FONCTIONS

           function initEnterpriseSelect() {

           var e = [{t : 'enterprise', c : ['id', 'region', 'country', 'city', 'name', 'phone', 'email', 'type', 'cashAccount']}]; //e pour entities
           enterpriseSelect_query.e = e;
           var requetteEntreprise = JSON.stringify(enterpriseSelect_query);
           var enterpriseSelect_store = new JsonRest({
               target: "/data/Entreprise",
               getLabel: function (data) {
                 return data.name + "-" + data.region;
               }
             });
           enterpriseSelect = new SelectX({
             store: enterpriseSelect_store,
             style: "width: 135px",
             query: '?' + requetteEntreprise
           }, "enterpriseSelect");
             var deferred = new Deferred();
               enterpriseSelect.on("setStore", function () {
               var IDEntreprise = this.get('value');
               deferred.resolve(IDEntreprise);
             });
             return deferred.promise;
           } 

            function initAccountSelect (IDEntreprise) {
             //preparation requette
             var e = [{t : 'account', c : ['id', 'accountLocked', 'accountTxt', 'accountTypeId', 'accountCategory']}];
             var c = [{t : 'account', cl : 'enterpriseId', v : IDEntreprise, z : '='}];
             accountSelect_query.e = e;
             accountSelect_query.c = c;
             var requetteAccount = JSON.stringify(accountSelect_query);
             var accountSelection_store = new JsonRest({
                 target: '/data/Account',
                 getLabel: function (data) {
                   return (data.id + "-" + data.accountTxt);
                 }
               });
             accountSelect = new SelectX({
               store: accountSelection_store,
               style: "width: 220px", //update this shit
               query: '?' + requetteAccount
             }, "accountSelect");
             accountSelect.detect(enterpriseSelect, 'onChange', function(value) {
              accountSelect_query.c[0]['v'] = value;
              requetteAccount = JSON.stringify(accountSelect_query);
                var query = '?'+requetteAccount;
                accountSelect.requery(query);
                });
              var deferred = new Deferred();
             accountSelect.on("setStore", function () {
               var IDAccount = this.get('value');
               deferred.resolve(IDAccount);
             });
             return deferred.promise;
           } 

           function initFiscalYearSelect(IDEntreprise) {

             //preparation requette
             var e = [{t : 'fiscalyear', c : ['id', 'numberOfMonths', 'fiscalYearTxt', 'transactionStartNumber', 'transactionStopNumber', 'fiscalYearNumber']}];
             var c = [{t : 'fiscalyear', cl : 'enterpriseId', v : IDEntreprise, z : '='}];
             fiscalYearSelect_query.e = e;
             fiscalYearSelect_query.c = c;
             var requetteFiscalYear = JSON.stringify(fiscalYearSelect_query);
             var fiscalYearSelect_store = new JsonRest({
                 target: '/data/fiscalyear',
                 getLabel: function (data) {
                   return (data.id + "-" + data.fiscalYearTxt);
                 }
               });
             fiscalYearSelect = new SelectX({
               store: fiscalYearSelect_store,
               style: "width: 220px", //update this shit
               query: '?' + requetteFiscalYear
             }, "fiscalYearSelect");

             fiscalYearSelect.detect(enterpriseSelect, 'onChange', function(value) {              
              fiscalYearSelect_query.c[0]['v'] = value;
              requetteFiscalYear = JSON.stringify(fiscalYearSelect_query);
                var query = '?'+requetteFiscalYear;
                fiscalYearSelect.requery(query);
                });

             fiscalYearSelect.on("change", function(data){
              console.log("hdslkglglgsd");

             });
                                 var deferred = new Deferred();
             fiscalYearSelect.on("setStore", function () {
               var IDFiscalYear = this.get('value');
               deferred.resolve(IDFiscalYear);
                      });
             return deferred.promise;
           }

           function getDateFrom(IDFY) {
            //preparation requette
            e = [{t : 'period', c: ['fiscalYearId', 'id', 'periodStart', 'periodStop', 'order']}];
            c = [{t : 'period', cl : 'fiscalYearId', v : IDFY, z : '='}];

            dateFrom_query.e = e;
            dateFrom_query.c = c;
            var requetteDateFrom = JSON.stringify(dateFrom_query);


            //construction de store et du select
            var dateFrom_store = new JsonRest({
              target : '/data/period',
              getLabel : function (data) {
                return formatDate(data.periodStart);
              }
            });

            dateFromSelect = new SelectX({
              store : dateFrom_store,
              style: "width: 220px", //update this shit
               query: '?' + requetteDateFrom
            },"dateSelectFrom");

             dateFromSelect.detect(fiscalYearSelect, 'onChange', function(value) {
      dateFrom_query.c[0]['v'] = value;
              requetteDateFrom = JSON.stringify(dateFrom_query);
                var query = '?'+requetteDateFrom;
                dateFromSelect.requery(query);
    });
            var deferred = new Deferred();
             dateFromSelect.on("setStore", function() {
                        var dateF = this.get('displayedValue');
                        deferred.resolve(dateF);
                    });
             return deferred.promise;
           }

           function getDateTo(IDFY) {
            //preparation requette
            e = [{t : 'period', c: ['fiscalYearId', 'id', 'periodStart', 'periodStop', 'order']}];

            var c = [{t : 'period', cl : 'fiscalYearId', v : IDFY, z : '='}];
            dateTo_query.e = e;
            dateTo_query.c = c;
            var requetteDateTo = JSON.stringify(dateTo_query);


            //construction de store et du select
            var dateTo_store = new JsonRest({
              target : '/data/period',
              getLabel : function (data) {
                return formatDate(data.periodStop);
              }
            });

            dateToSelect = new SelectX({
              store : dateTo_store,
              style: "width: 220px", //update this shit
               query: '?' + requetteDateTo
            },"dateSelectTo");

                dateToSelect.detect(fiscalYearSelect, 'onChange', function(value) {
      dateTo_query.c[0]['v'] = value;
              requetteDateTo = JSON.stringify(dateTo_query);
                var query = '?'+requetteDateTo;
                dateToSelect.requery(query);
    });
               var deferred = new Deferred();
             dateToSelect.on("setStore", function() {
                        var dateT = this.get('displayedValue');
                        deferred.resolve(dateT);
                    });
             return deferred.promise;
           }

           function initGrid(param) {
            var grid_store = new JsonRest({
                        target: 'data/transaction/',
                        idProperty: "lineId"
                    });

                    var columns = [{
                        id: 'LineId',
                        field: 'lineId',
                        name: 'LineId',
                        editable: true
                    }, {
                        id: 'AccountId',
                        field: 'accountId',
                        name: 'AccountId',
                        editable: true
                    }, {
                        id: 'Credit',
                        field: 'credit',
                        name: 'Credit',
                        editable: true
                    }, {
                        id: 'Debit',
                        field: 'debit',
                        name: 'Debit'
                    }, {
                        id: 'docId',
                        field: 'docId',
                        name: 'DocId'
                    }, {
                        id: 'transNumber',
                        field: 'transNumber',
                        name: 'Transaction Number'
                    }, {
                        id: 'transDate',
                        field: 'transDate',
                        name: 'Transaction Date',
                        formatter: function(data) {
                            return formatDate(data.transDate);
                        }
                    }];

                    e = [{t : 'transaction', c : ['lineId', 'accountId', 'credit', 'debit', 'docId', 'description', 'transNumber', 'transDate', 'sysCurrency', 'transCurrency', 'exchangeRate']}];
                    c = [{t : 'transaction', cl: 'accountId', v : param.IDAccount, z : '=', l : 'AND'}, 
                    {t : 'transaction', cl : 'transDate', v : convertToMysqlDate(param.dateFrom), z : '>=', l : 'AND'}, 
                    {t : 'transaction', cl : 'transDate', v : convertToMysqlDate(param.dateTo), z : '<='} ];
                    grid_query.e = e;
                    grid_query.c = c;                    
                    var requetteGrid = JSON.stringify(grid_query);


                    masterGrid = new Grid({
                        id: 'master',
                        style: "height: 100%", //add this to grid style css or some shyt
                        cacheClass: Cache,
                        store: grid_store,
                        query: '?'+requetteGrid,
                        structure: columns,
                        selectRowTriggerOnCell: true,
                        modules: [
                            CellWidget,
                            SingleSort,
                            Row
                            //Bar
                        ],
                        autoHeight: true
                    }, "masterGrid");
                    masterGrid.startup();


           }
           Date.prototype.toMySqlDate = function (dateParam) {
            var date = new Date(dateParam);
            var annee, mois, jour;
        annee = String(date.getFullYear());
        mois = String(date.getMonth() + 1);
        if (mois.length == 1) {
            mois = "0" + mois;
        }
        jour = String(date.getDate());
        if (jour.length == 1) {
            jour = "0" + jour;
        }
        return annee + "-" + mois + "-" + jour;
                  };

           function formatDate(dateString) {
                    var obj = new Date(dateString);
                    return obj.toDateString();
                }

                function convertToMysqlDate(dateString) {
                  var mySqlDate = new Date().toMySqlDate(dateString);
                  return mySqlDate;

                }
         });
  </script>

    </head>
    <body class = "claro">
      <div>
       <div id="headerSelection">
          <div id="accountSelect"></div>
          <span>From:</span>
          <div id="dateSelectFrom"></div>
          <span>To:</span>
          <div id="dateSelectTo"></div>
       </div>

       <div id="masterGrid"></div>
       <div id="slaveContent">  
          <div id="slaveGrid"></div>
       </div>

       <div id="footerSelection" style="position: fixed; left: 0px; bottom: 0px;">
          <span>Enterprise</span>
          <div id="enterpriseSelect"></div>
          <span>Fiscal Year</span>
            <div id="fiscalYearSelect"></div>
       </div>
      </div>
    </body>
</html>   