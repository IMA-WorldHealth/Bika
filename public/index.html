<!DOCTYPE html>
<html >
<head>
  <title>Main Page</title>
  <link rel = "stylesheet" type = "text/css" href="./css/principal.css" media="screen" />
  <link rel="stylesheet" href="js/dojoos/dijit/themes/claro/claro.css"/>
  <script>dojoConfig = {parseOnLoad: true}</script>
  <script type="text/javascript" src="js/dojoos/dojo/dojo.js"></script>
  <script>
    require(["dijit/layout/BorderContainer", "dijit/Menu", "dijit/MenuItem", "dijit/MenuSeparator", "bika/TabManager/AddTabManager", "dijit/tree/ObjectStoreModel", "dijit/Tree", "dojo/store/JsonRest", "dojo/parser", "dijit/layout/ContentPane", "dojo/domReady!"],
      function(BorderContainer, Menu, MenuItem, MenuSeparator, AddTabManager, ObjectStoreModel, Tree, JsonRest, parser, ContentPane, ready) {
        var treeStore = new JsonRest({
          target: '/tree',
          getChildren: function(object) {
            return this.query("?" + JSON.stringify({
              'entities': [{
                t: 'unit',
                c: ['id', 'name', 'desc', 'parent', 'hasChildren', 'url']
              }],
              'cond': [{
                t: 'unit',
                cl: 'parent',
                z: '=',
                v: object.id
              }]
            }));
          }
        });

        var bc = new BorderContainer({
          style: "height: 100%; width: 100%; margin: 0; padding: 0;"
        }, "bc");

        var tabManager = new AddTabManager({}, "tab_container");
        var sidebar = new ContentPane({
          region: 'leading',
          style: 'width:15%;'
        }, "sidebar");

        var center_panel = new ContentPane({
          region: 'center',
          style: "margin:0; padding:0;"
        }, "center_panel");

        bc.addChild(center_panel);
        bc.addChild(sidebar);

        treeModel = new ObjectStoreModel({
          store: treeStore,
          query: "?" + JSON.stringify({
            'entities': [{
              t: 'unit',
              c: ['id', 'name', 'desc', 'parent', 'hasChildren', 'url']
            }],
            'cond': [{
              t: 'unit',
              cl: 'id',
              z: '=',
              v: 0
            }]
          }),
          mayHaveChildren: function(obj) {
            return obj.hasChildren;
          }
        });

        var unitsTree = new Tree({
          model: treeModel,
          showRoot: false,
          onOpenClick: true,
          onClick: function(item) {
            if (item.hasChildren === 0) {
              tabManager.openTab(item.name, item.url, true);
            }
          }
        }, "tree");

        var menuContext = new Menu({
          targetNodeIds: ["tree"],
          selector: ".dijitTreeNodeContainer > .dijitTreeNode > .dijitTreeNodeContainer > .dijitTreeNode", // FIXME
          id: "menuContext",
          style: "display: none;",
        });
        
        var open = new MenuItem({
          label: "Open in new tab",
          onClick: function(item) {
            var itemTree = dijit.byNode(this.getParent().currentTarget);
            if (itemTree.item.hasChildren === 0) {
              tabManager.newTab(itemTree.item.name, itemTree.item.url, true);
            }
          }
        });
        
        menuContext.addChild(open);

        bc.startup();
        menuContext.startup();
        unitsTree.startup();

      });
  </script>
</head>
<body class="claro">
  <div id="bc">  
    <div id="sidebar">
      <div id="tree"></div>
    </div>
    <div id="center_panel">
      <div id="tab_container"></div>
    </div>
  </div>
</body>
</html>
