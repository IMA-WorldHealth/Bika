<html>
    <head>
        <title>GRIDX BIKA</title>
        <link rel="stylesheet" href="./js/dojoos/dijit/themes/claro/claro.css" media="screen"/>
        <link rel="stylesheet" href="./js/dojoos/gridx/resources/claro/Gridx.css"/>
        <script src="./js/dojoos/dojo/dojo.js" data-dojo-config="async:true" ></script>
         <script>
            var dojoConfig = {
                //async true causes the HTML to be displayed before executing the javascript - there must be a fix for this
                async: false,
                isDebug: true,
                parseOnLoad: false
              };
        </script>

         <script>
         var enterpriseSelect;
  require(["customizedModule/SelectX",
    "dojo/store/JsonRest",
    "dojo/on",
    "dojo/Deferred",
    "dojo/promise/all",
    "dojo/domReady!"
    ], function (SelectX, JsonRest, on, Deferred, all) {
    	

    //construction requette pour entrepriseselect
    var enterpriseSelect_query = {};
    var e = [{t : 'enterprise', c : ['id', 'region', 'country', 'city', 'name', 'phone', 'email', 'type', 'cashAccount']}]; //e pour entities
    enterpriseSelect_query.e = e;
    var requetteEntreprise = JSON.stringify(enterpriseSelect_query);
    //fin construction de la requette

    //construction store et select pour entreprise
    var enterpriseSelect_store = new JsonRest({
      target: "/data/Entreprise",
      getLabel: function (data) {
        return data.name + "-" + data.region;
      }
    });

    enterpriseSelect = new SelectX({
      store: enterpriseSelect_store,
      style: "width: 135px",
      query: '?' + requetteEntreprise
    }, "enterpriseSelect");
    //fin construction store et select pour entreprise
    //construction requette pour account_select
    var IDEntreprise;
    var accountSelect_query = {};
    var process =  getIDEntreprise();
    process.then(function (value) {
    	return all({IDAccount : initAccountSelect(value), IDFiscalYear : initFiscalYearSelect(value)});
    });
   


    e = [{t : 'account', c : ['id', 'accountLocked', 'accountTxt', 'accountTypeId', 'accountCategory']}];
    var c = [{t : 'account', cl : 'EnterpriseId', v : IDEntreprise, z : '='}];
    accountSelect_query.e = e;
    accountSelect_query.c = c;
    var requetteAccount = JSON.stringify(accountSelect_query);

    //construction store et select pour compte
    var accountSelection_store = new JsonRest({
      target: '/data/Account',
      getLabel: function (data) {
        return (data.id + "-" + data.accountTxt);
      }
    });

    var accountSelect = new SelectX({
      store: accountSelection_store,
      style: "width: 220px", //update this shit
      query: '?' + requetteAccount
    }, "accountSelect");
     accountSelect.detect(enterpriseSelect, 'onChange', function(value) {
 	console.log('maman');
      //var query = '?q={"EnterpriseId":"' + value + '"}'
     // accountSelect.requery(query);
    });

     //LES FONCTIONS

     function getIDEntreprise(){
     	var deferred = new Deferred();
     	 enterpriseSelect.on("setStore", function() {
                       IDEntreprise = this.get('value');
                       deferred.resolve(IDEntreprise);                        
                    });
     	 return deferred.promise;
     }

     function getIDAccount(IDEntreprise) {

     }
  });


  </script>

    </head>
    <body class = "claro">
     <div>

                <div id="headerSelection">
                    <div id="accountSelect"></div>
                    <span>From:</span>
                    <div id="dateSelectFrom"></div>
                    <span>To:</span>
                    <div id="dateSelectTo"></div>
                </div>

                <div id="masterGrid"></div>

                <div id="slaveContent">  
                    <div id="slaveGrid"></div>
                </div>

                <div id="footerSelection" style="position: fixed; left: 0px; bottom: 0px;">
                    <span>Enterprise</span>
                    <div id="enterpriseSelect"></div>
                    <span>Fiscal Year</span>
                    <div id="fiscalYearSelect"></div>
                </div>
        </div>
    </body>
</html>












   