<!DOCTYPE html>
<html>
<head>
  <title>Main Page</title>
  <meta charset="utf-8">
  <link rel="stylesheet" href="./css/principal.css" media="screen" />
  <link rel="stylesheet" href="js/dojoos/dijit/themes/claro/claro.css"/>
  <link rel="stylesheet" href="./css/icons/iconic_fill/iconic_fill.css"/>
  <script>dojoConfig = {parseOnLoad: true}</script>
  <script type="text/javascript" src="js/dojoos/dojo/dojo.js"></script>
  <script>
    require(["dijit/layout/BorderContainer", "dijit/Menu", "dijit/MenuItem", "dijit/MenuSeparator", "bika/TabManager/AddTabManager", "dijit/tree/ObjectStoreModel", "dijit/Tree", "dojo/store/JsonRest", "dijit/layout/ContentPane", "dojo/domReady!"],
      function(BorderContainer, Menu, MenuItem, MenuSeparator, AddTabManager, ObjectStoreModel, Tree, JsonRest, ContentPane) {
        var treeStore = new JsonRest({
          target: '/tree',
          getChildren: function(object) {
            return this.query("?" + JSON.stringify({
              'entities' : [{
                t : 'unit',
                c : ['id', 'name', 'desc', 'parent', 'has_children', 'url']
              }],
              'cond' : [{
                t : 'unit',
                cl: 'parent',
                z : '=',
                v : object.id
              }]
            }));
          }
        });

        var bc = new BorderContainer({}, "bc");

        var tabManager = new AddTabManager({}, "tab_container");
        var sidebar = new ContentPane({
          region: 'leading',
        }, "sidebar");

        var center_panel = new ContentPane({
          region: 'center',
        }, "center_panel");

        bc.addChild(center_panel);
        bc.addChild(sidebar);

        treeModel = new ObjectStoreModel({
          store: treeStore,
          query: "?" + JSON.stringify({
            'entities': [{
              t: 'unit',
              c: ['id', 'name', 'desc', 'parent', 'has_children', 'url']
            }],
            'cond': [{
              t: 'unit',
              cl: 'id',
              z: '=',
              v: 0
            }]
          }),
          mayHaveChildren: function(obj) {
            return obj.has_children;
          }
        });

        var unitsTree = new Tree({
          model: treeModel,
          showRoot: false,
          onOpenClick: true,
          onClick: function(item) {
            if (item.has_children === 0) {
              tabManager.openTab(item.name, item.url, true);
            }
          }
        }, "tree");

        var menuContext = new Menu({
          targetNodeIds: ["tree"],
          selector: ".dijitTreeNodeContainer > .dijitTreeNode > .dijitTreeNodeContainer > .dijitTreeNode", // FIXME: find a better selector
          id: "menuContext",
          style: "display: none;"
        });
        
        var open = new MenuItem({
          label: "Open in new tab",
          onClick: function(item) {
            var itemTree = dijit.byNode(this.getParent().currentTarget);
            if (itemTree.item.has_children === 0) {
              tabManager.newTab(itemTree.item.name, itemTree.item.url, true);
            }
          }
        });
        
        menuContext.addChild(open);
        
        bc.startup();
        menuContext.startup();
        unitsTree.startup();

      });
  </script>
</head>
<body class="claro">
  <div id="bc">
    <div id="sidebar">
      <div class="dock">
        <ul>
          <li><a class="iconic cog" href="/logout"></a></li>
          <li><a class="iconic equalizer" href="#"></a></li>
          <li><a class="iconic home" href="#"></a></li>
        </ul>
      </div>
      <div id="tree"></div>
      <div id="change_enterprise">
      </div>
    </div>
    <div id="center_panel">
      <div id="tab_container"></div>
    </div>
  </div>
</body>
</html>
