<!--The main motivation page is compare the functionality of dojo and angular for representing data-->
<link href="../css/mvc.css" rel="stylesheet">

<div id="container">
  <table class="budget-table">
    <thead>
      <tr>
        <th>Account ID</th>
        <th>Account Text</th>
        <th>Account Category</th>
      </tr>
    </thead>
    <tbody id="table-body">
      <!--Populated by dojo-->
    </tbody>
  </table>
</div>

<script>

//Enable manipulation with browser console
var restStore;
var memoryStore;
var cacheStore;


require(["dojo/on", "dojo/Deferred", "dojo/query", "dojo/when", "dojo/store/JsonRest", "dojo/store/Memory", "dojo/store/Cache", "dojo/dom", "dojo/Stateful", "dojo/store/Observable", "dojo/dom-construct", "dojo/domReady!"], 
  function(on, Deferred, query, when, JsonRest, Memory, Cache, dom, Stateful, Observable, domConstruct) {

    /////
    // Scratch page for MVC PoC
    // -Components and model should register dependencies, loaded in the correct order, and updates should propegate through depencies
    // -Components should directly relfect changes in model
    //  -model should only be changed and updated given an update in a dependency(selection changed etc.) or a direct update from the server
    /////
    
    /////
    // Basic test of dojo MVC
    //  -Stores declared in gloabal namepsace, use CRUD commands to update stores and view reflection in the view
    //    -memoryStore.put({id:0, account_txt:"Account text for 0", account_type_id:1});
    //    -memoryStore.put({id:999999, account_txt:"Account text for 999999", account_type_id:1});
    /////
    
    //Query for current version of db.js
    var account_query = {};
    var e = [{t : 'account', c : ['id', 'locked', 'account_txt', 'account_type_id', 'account_category']}];
    var c = [{t : 'account', cl : 'enterprise_id', v : 101, z : '='}];

    account_query.e = e;
    account_query.c = c;
   
    var format_account_query = '?' + JSON.stringify(account_query);

    //Interface with the server
    restStore = new JsonRest({  
      target : '/data/' + format_account_query
    });

    //Store data, ref: bika/Memory
    memoryStore = new Memory({});
    memoryStore = new Observable(memoryStore);

    //Memory store interfaces with restStore
    cacheStore = new Cache(restStore, memoryStore);
    cacheStore.query();

    var session_data = memoryStore.query({}, {sort: [{attribute: "account_txt"}]});
    viewData(session_data);

    //Bind 'memoryStore' model with table
    function viewData(results) { 
      var container = dom.byId("table-body");
      var rows = [];

      results.forEach(insertRow);

      results.observe(function(item, removedIndex, insertedIndex) { 
        console.log("Change in memoryStore: ", item, " removedIndex [", removedIndex, "] insertedIndex [", insertedIndex, "]");
        if(removedIndex > -1) { 
          removeRow(removedIndex);
        }
        if(insertedIndex > -1) { 
          insertRow(item, insertedIndex);
        }
      }, true);

      function insertRow(item, i) { 
        //Reformat how domConstruct adds a row, first construct a tr, add td etc.
        var table_row = domConstruct.create("tr");
        var table_id_data = domConstruct.create("td", {
          innerHTML: item.id
        }, table_row);
        var table_text_data = domConstruct.create("td", { 
          innerHTML: item.account_txt
        }, table_row);
        var table_category_data = domConstruct.create("td", { 
          innerHTML: item.account_category
        }, table_row);

        rows.splice(i, 0, container.insertBefore(table_row, rows[i] || null));
      }

      function removeRow(i) { 
        //get first element returned by Array.splice (remove 1 object from position i)
        domConstruct.destroy(rows.splice(i, 1)[0]);
      }

    }
});

</script>

