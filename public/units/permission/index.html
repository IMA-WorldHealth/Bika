<html>
    <head>
        <title>USER PERMISSION</title>
        
        <link rel="stylesheet" href="./js/dojoos/dijit/themes/claro/claro.css" media="screen"/>
        <link rel="stylesheet" href="./js/dojoos/gridx/resources/claro/Gridx.css"/> 
        <link rel = "stylesheet" type = "text/css" href="../css/userPermission.css" media="screen" />
        <script>
        var roleGrid; 
        require(["customizedModule/SelectX",
         	"customizedModule/FormChooser",
           "dojo/store/JsonRest",
           "dijit/form/TextBox",
           "dijit/form/CheckBox",
           "dijit/form/Button",
           "dijit/form/Form",
           "dojo/on",
           "dojo/Deferred",
           "dojo/promise/all",
           "gridx/core/model/cache/Async",
           "gridx/modules/SingleSort",
           "gridx/modules/extendedSelect/Row",
           "gridx/modules/CellWidget",
           "gridx/Grid",
           "dojox/grid/DataGrid",
           "dojo/topic",
           "dijit/Dialog",
           "dojo/dom-construct",
           "dojo/domReady!"
           ], function (SelectX, FormChooser, JsonRest,TextBox,CheckBox, Button, Form, on, Deferred, all, Cache, SingleSort, Row, CellWidget, Grid, DataGrid, topic, Dialog, domCons){
           	//declarations des variables
           	var bValider, bAnnuler, txtFirstName, txtLastName, txtEmail,
           	 txtUserName, txtPassWord, txtConformPassWord, chkAdministrator,
              chkFinance, chkManager, chkDocteur, chkAdmin, roleStore,
               userGrid, userStore, roleGridQuery = {}, userGridQuery = {}, crudStore;

           	  //creations champs des saisies
           	txtFirstName = new TextBox({class:"saisie", style:"width:220px;"},"firstnameID");
           	txtLastName = new TextBox({class:"saisie", style:"width:220px;"},"lastnameID");
           	txtEmail = new TextBox({class:"saisie", style:"width:220px;"},"emailID");
           	txtUserName = new TextBox({class:"saisie", style:"width:220px;"},"usernameID");
           	txtPassWord = new TextBox({class:"saisie", type:"password", style:"width:220px;"},"passwordID");
           	txtConformPassWord = new TextBox({class:"saisie", type:"password", style:"width:220px;"},"confirmpasswordID");

           	//creation des cases a caucher
            chkAdministrator = new CheckBox({value:'Administrator'},"chkadministratorID");
           	chkAdmin = new CheckBox({value:'admin'},"chkadminID");
           	chkFinance = new CheckBox({value:'Finance'},"chkfinanceID");
           	chkManager = new CheckBox({value:'Manager'},"chkmanagerID");
           	chkDocteur = new CheckBox({value:'Docteur'},"chkdocteurID");

           	//creation des boutons
           	bValider = new Button({label:"Creer", onClick:valider}, "validerID");
           	bAnnuler = new Button({label:"Annuler"},"annulerID");

            //stores
            crudStore = new JsonRest({target:'/data/'});
             var fcAdmin, fcFinance;

             (function(){
              fcAdmin = new FormChooser({name:"admin"},"adminroleformID");
              var tabUnitsID = fcAdmin.getUnitsID();
              tabUnitsID.then(function(value){
                var node;
                for(var i = 0; i< value.length; i++) {
                      node = domCons.toDom("<div id=\""+value[i]+'ID'+"\"></div><span>"+value[i]+"</span><br/>"); 
                      domCons.place(node,"adminroleformID");
                      }
                      node = domCons.toDom("<div id=\""+"adminroleformIDAll"+"\"></div><span>"+"Tous"+"</span><br/>"); 
                      domCons.place(node,"adminroleformID");
                      node = domCons.toDom("<div id=\""+"adminroleformIDOK"+"\"></div>"); 
                      domCons.place(node,"adminroleformID");
                      fcAdmin.placeControls(value); 
                      fcAdmin.addLastCheck("adminroleformIDAll");
              new Button({label:'Ok', onClick:sauver}).placeAt(fcAdmin.domNode);
              fcAdmin.startup();

              });
            })();

            //surveillance
            on(chkAdmin, 'change', function(value){
              if(chkAdmin.get('checked')){
                showChoix(chkAdmin.value, "adminroleformID");
              }
            });
           	initUnitGrid();
            initUserGrid();




           	//LES FONCTIONS         

            function showChoix(label, idDom){              
              var dialog = new Dialog({style : "width:250px", content:fcAdmin});
              dialog.show();
                          }

            function valider(){
              var sql1 = {t:'user', data:[{id:'', username: txtUserName.value, password: txtPassWord.value, first: txtFirstName.value, last:txtLastName.value, email:txtEmail.value, loggedIn:0}]};
              crudStore.put(sql1);
              var sql ={} ;               
              if(chkAdministrator.checked === true){
                sql.e = [{t : 'role', c : ['id']}];
                sql.cond = [{t:'role', cl:'name', v:chkAdministrator.value, z:'='}];
                crudStore.query(sql).then(function(item){
                  var id_role = item[0].id;
                  sql.e=[{t:'user', c:['id']}];
                  sql.cond = [{t:'user', cl:'username', v:txtUserName.value, z:'=', l:'AND'}, {t:'user', cl:'password', v:txtPassWord.value, z:'='}];
                  crudStore.query(sql).then(function(item){
                    var id_user = item[0].id;
                    var sql2 = {t:'user_role', data:[{id:'', id_role:id_role, id_user:id_user, allRight:1}]};
                    crudStore.put(sql2);                    
                  });

                });
              }else{
                if(chkAdmin.checked === true){
                  sql.e = [{t : 'role', c : ['id']}];
                sql.cond = [{t:'role', cl:'name', v:chkAdmin.value, z:'='}];
                crudStore.query(sql).then(function(item){
                  var id_role = item[0].id;
                  sql.e=[{t:'user', c:['id']}];
                  sql.cond = [{t:'user', cl:'username', v:txtUserName.value, z:'=', l:'AND'}, {t:'user', cl:'password', v:txtPassWord.value, z:'='}];
                  crudStore.query(sql).then(function(item){
                    var id_user = item[0].id;
                    var sql2 = {t:'user_role', data:[{id:'', id_role:id_role, id_user:id_user, allRight:1}]};
                    crudStore.put(sql2);                    
                  });

                });
                }

                if(chkFinance.checked === true){
                  sql.e = [{t : 'role', c : ['id']}];
                sql.cond = [{t:'role', cl:'name', v:chkAdmin.value, z:'='}];
                crudStore.query(sql).then(function(item){
                  var id_role = item[0].id;
                  sql.e=[{t:'user', c:['id']}];
                  sql.cond = [{t:'user', cl:'username', v:txtUserName.value, z:'=', l:'AND'}, {t:'user', cl:'password', v:txtPassWord.value, z:'='}];
                  crudStore.query(sql).then(function(item){
                    var id_user = item[0].id;
                    var sql2 = {t:'user_role', data:[{id:'', id_role:id_role, id_user:id_user, allRight:1}]};
                    crudStore.put(sql2);                    
                  });

                });
                }
                if(chkManager.checked === true){
                  sql.e = [{t : 'role', c : ['id']}];
                sql.cond = [{t:'role', cl:'name', v:chkAdmin.value, z:'='}];
                crudStore.query(sql).then(function(item){
                  var id_role = item[0].id;
                  sql.e=[{t:'user', c:['id']}];
                  sql.cond = [{t:'user', cl:'username', v:txtUserName.value, z:'=', l:'AND'}, {t:'user', cl:'password', v:txtPassWord.value, z:'='}];
                  crudStore.query(sql).then(function(item){
                    var id_user = item[0].id;
                    var sql2 = {t:'user_role', data:[{id:'', id_role:id_role, id_user:id_user, allRight:1}]};
                    crudStore.put(sql2);                    
                  });

                });
                }

                if(chkDocteur.checked === true){
                  sql.e = [{t : 'role', c : ['id']}];
                sql.cond = [{t:'role', cl:'name', v:chkAdmin.value, z:'='}];
                crudStore.query(sql).then(function(item){
                  var id_role = item[0].id;
                  sql.e=[{t:'user', c:['id']}];
                  sql.cond = [{t:'user', cl:'username', v:txtUserName.value, z:'=', l:'AND'}, {t:'user', cl:'password', v:txtPassWord.value, z:'='}];
                  crudStore.query(sql).then(function(item){
                    var id_user = item[0].id;
                    var sql2 = {t:'user_role', data:[{id:'', id_role:id_role, id_user:id_user, allRight:1}]};
                    crudStore.put(sql2);                    
                  });
                });
                }

              }




            }
           function	initUnitGrid(){
            console.log(CellWidget.backupCount);
            var hasWidget;
           	roleStore = new JsonRest({
                        target: '/data/'
                    });

                    var columns = [{
                        id: 'id',
                        field: 'id',
                        name: 'ID'
                    }, {
                        id: 'name',
                        field: 'name',
                        name: 'UNIT NAME'
                    }, {
                        id: 'desc',
                        field: 'desc',
                        name: 'UNIT DESCRIPTION'
                    }];

                    var e = [{t : 'unit', c : ['id', 'name', 'desc']}];                    
                    roleGridQuery.e = e;
                    var requetteGrid = JSON.stringify(roleGridQuery);

                    roleGrid = new Grid({
                        style: "height:300px;",
                        cacheClass: Cache,
                        store: roleStore,
                        query: '?'+requetteGrid,
                        structure: columns,
                        selectRowTriggerOnCell: true,
                        modules: [
                            CellWidget,
                            SingleSort,
                            Row
                            ]
                    }, "divTabRole");            
            roleGrid.startup();	

           	}

             function initUserGrid(){
            userStore = new JsonRest({
                        target: '/data/'
                    });

                    var columns = [{
                        id: 'id',
                        field: 'id',
                        name: 'ID'
                    }, {
                        id: 'username',
                        field: 'username',
                        name: 'USER NAME'
                    }, {
                        id: 'email',
                        field: 'email',
                        name: 'EMAIL'
                    }];

                    var e = [{t : 'user', c : ['id', 'username', 'email']}];                    
                    userGridQuery.e = e;
                    var requetteGrid = JSON.stringify(userGridQuery);

                    userGrid = new Grid({
                        style: "height:240px;",
                        cacheClass: Cache,
                        store: userStore,
                        query: '?'+requetteGrid,
                        structure: columns,
                        selectRowTriggerOnCell: true,
                        modules: [
                            SingleSort,
                            ],
                    }, "sub");
            chkAdmin.startup();
            chkDocteur.startup();
            chkFinance.startup();
            chkManager.startup();
            chkAdministrator.startup();
            userGrid.startup(); 
            }

            function sauver(){
              for(var i=0; i<fcAdmin.checks.length; i++){
                console.log(fcAdmin.checks);
              }

            }
        });
        </script>      
         

    </head>
    <body class = "claro">
     <div id="principal">
     	<div id="divForm">
     	    <form id="newuserformID">
	            <div><label><b>First Name :</b></label><div class="saisie" id="firstnameID"></div></div>
	            <br/>
	            <div><label><b>Last Name :</b></label><div class="saisie" id="lastnameID"></div></div>
	            <br/>
	            <div><label><b>Email :</b></label><div class="saisie" id="emailID"></div></div>
	            <br/>
	            <span id="spanbademailID"><div id="bademailID"></div></span>
	            <br/>
	            <div><label><b>User Name :</b></label><div  class="saisie" id="usernameID"></div></div>
	            <br/> 
	            <div><label><b>Password :</b></label><div class="saisie" id="passwordID"></div></div>
	            <br/>
	            <div><label><b>Confirm Password :</b></label><div class="saisie" id="confirmpasswordID"></div></div>
	            <br/>
              <span id="spanbadpasswordID"><div id="badpasswordID"></div></span><br/>

	            <div id="roleID"><div id="chkadministratorID"></div><b>Administrator </b>
              <div id="chkadminID"></div><b>Admin </b>
              <div id="chkfinanceID"></div><b>Finance </b>
              <div id="chkmanagerID"></div><b>Manager </b>
              <div id="chkdoctorID"></div><b>Doctor</b>	            
	            <br/>  </div>              
	            <div><div id="validerID"></div><div id="annulerID"></div></div>
          </form>     		
     	</div>
      
      <div id="divTabRole">
     		
     	</div>
    </div>
    <div id="sub">
      
    </div>
    <div id="financeroleformID"></div><div id="adminroleformID"></div><div id="managerroleformID"></div><div id="doctorroleformID"></div>    
     </body>
</html>   

