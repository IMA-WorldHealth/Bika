<!--
  This is the INCORRECT VERSION, kept for PoC. Pardon, pardon
  TODO: 
 -Rendering of tables got fragmented during concept change
 -Add year ended to title of the tables
-->
<link href="../css/budget.css" rel="stylesheet"> <!-- link is only supposed to go in head .. http://www.w3schools.com/tags/tag_link.asp -->
<div id="units.budgeting.selectbox"><p>Select an Account:</p><div id="units.budgeting.accountselect"></div></div>
<!--div id="units.budgeting.fiscalbox"><p>Select a Fiscal Year:</p><div id="units.budgeting.fiscalselect"></div></div-->
<!-- form template -->
<div id="units-budgeting-formdisplay">
  <form id="units-budgeting-budgetform">
    <!--Rendered with dojo-->
  </form>

  <button id="units-budgeting-update">Update</button>
</div>

<script>
require(["dojo/dom-attr", "dojo/request", "dojo/query", "dojo/dom-construct", "dojo/dom", "dojo/store/JsonRest", "dijit/form/Select", "dojo/on", "dojo/Deferred", "dojo/promise/all", "dojo/domReady!"], 
  function(domAttr, request, query, domConstruct, dom, JsonRest, Select, on, Deferred, all) {
    
  //assuming enterprise IMA-Kinshasa (101) - get this from the selection at the top of the application 
  var E_ID = 101;
  var fiscal_year_id = 2013001;

  var account_loaded = false;
  var fiscal_loaded = false;

  var tables = ["prev-year", "current-year", "next-year"];
  
  //Budget model - populate this with downloaded budget data
  //this might be bad
  var budgetModel = new Array(3);
  for(var i=0; i<budgetModel.length; i++) { 
    budgetModel[i] = new Array();
  }

  console.log("budgetModel: ", budgetModel);

  var account, fiscal_year;
  var dependencies = {};

  initPage();

  function initPage() {

    var settupAccount = initAccountSelect(E_ID);

    settupAccount.then(function(value) {
      account = value; 
      return initFiscalSelect(E_ID);
     
    }).then(function(value){
       fiscal_year = value;
       paintBudget(fiscal_year, account);
  }); 

    //assing listerner to update button
    var update = dom.byId("units-budgeting-update");
    on(update, "click", function(event) { 
      console.log("Update clicked - this should definitely do something");
      updateModel();
    });

  }


  function initAccountSelect(enterprise_id) { 

    var deferred = new Deferred();

    //ACCOUNT SELECT
    var account_select_store = new JsonRest({
      target: '/data/',
      getLabel: function(data) {
        return data.id + " - " + data.account_txt; // coding against the old trackerv6.sql db
      }
    });

    var account_query = {};
    var e = [{t : 'account', c : ['id', 'locked', 'account_txt', 'account_type_id', 'account_category']}];
    var c = [{t : 'account', cl : 'enterprise_id', v : enterprise_id, z : '='}];

    account_query.e = e;
    account_query.c = c;
   
    var format_account_query = '?' + JSON.stringify(account_query);

    var account_select = new Select({
      store: account_select_store, 
      query: format_account_query
    }, "units.budgeting.accountselect");

    account_select.on("setStore", function() { 
      deferred.resolve(this.get('value'));
    });

    account_select.on("change", function(value) {
      account = value; 
      paintBudget(fiscal_year, account);
      console.log("Change - " + value);
    });

    return deferred.promise;

  }

  
  function initFiscalSelect(enterprise_id) { 
    var deferred = new Deferred();

    //FISCAL YEAR SELECT 
    var fiscal_select_store = new JsonRest({ 
      target: '/data/',
      getLabel: function(data) { 
        return data.start_month + '/' + data.start_year + ' - ' + data.fiscal_year_txt;
      }
    });

    var fiscal_query = {};
    var fe = [{t : 'fiscal_year', c : ['id', 'start_month', 'start_year', 'fiscal_year_txt']}];
    var fc = [{t : 'fiscal_year', cl : 'enterprise_id', v : E_ID, z : '='}];

    fiscal_query.e = fe;
    fiscal_query.c = fc;

    var format_fiscal_query = '?' + JSON.stringify(fiscal_query);

    var fiscal_select = new Select({ 
      store: fiscal_select_store, 
      query: format_fiscal_query
    }, "units.budgeting.fiscalselect");

    fiscal_select.on("setStore", function() { 
      deferred.resolve(this.get("value"));
    });

    fiscal_select.on("change", function(value) { 
      fiscal_year = value;
      console.log("Change - " + value);
      paintBudget(fiscal_year, account);
    })

    return deferred.promise;
  }
  

  var paintBudget = function(fiscal_year, account) { 

    //Request for all fiscal years 
    clearTables();
    clearModel();
    
    var fyear = {};
    var fe = [{t : 'fiscal_year', c : ['id', 'number_of_months', 'start_month', 'start_year', 'previous_fiscal_year', 'next_fiscal_year']}];
    var fc = [{t : 'fiscal_year', cl : 'id', v : fiscal_year, z : '='}];

    fyear.e = fe;
    fyear.c = fc;

    var fiscal_data;

    request.get('data/?' + JSON.stringify(fyear)).then(function(data) { 
        fiscal_data = JSON.parse(data)[0];
        console.log("Fiscal year downloaded " + fiscal_year);
        console.log(fiscal_data);

        console.log("Data on previous year: " + fiscal_data.previous_fiscal_year);
        console.log("Data on next year: " + fiscal_data.next_fiscal_year);

        var validateNext = fiscal_data.next_fiscal_year;
        var validatePrevious = fiscal_data.previous_fiscal_year;

        //this is abstract as fuck
        if(validateNext) {
          console.log("Next is valid");
          //getPeriods(validateNext, 2, account);
        } else { 
          //tableFill(2);
        }

        if(validatePrevious) { 
          console.log("Previous is valid");
          getPeriods(validatePrevious, 0, account);
        } else { 
          //tableFill(0);
        }

    });
    
    //getPeriods(fiscal_year, 1, account);
    
    renderTables();

  }

  var getPeriods = function(fiscal_year_id, year, account) { 

     
    console.log(account);

    var join_query = {
      'e' : [{
        t : 'period',
        c : ['period_start', 'period_stop'] 
      }, {
        t : 'budget',
        c : ['enterprise_id', 'account_id', 'period_id', 'budget']
      }],
      'jc': [{
        ts: ['period', 'budget'],
        c: ['period_id', 'period_id'],
        l: 'AND'
      }],
      'c': [{
        t: 'budget',
        cl: 'account_id',
        z: '=', 
        v: account, 
        l: 'AND' 
      }, 
      {
        t: 'period',
        cl: 'fiscal_year_id', 
        z: '=',
        v: fiscal_year_id
      }]};

      /*
      console.log(join_query);

      request.get('data/?' + JSON.stringify(join_query)).then(function(data) { 
        console.log("Data downloaded " + data);
      })*/


    var query = {};
    var pe = [{t : 'period', c : ['period_start', 'period_stop']}];
    var pc = [{t : 'period', cl : 'fiscal_year_id', v : fiscal_year_id, z : '='}];

    query.e = pe;
    query.c = pc;

    request.get('data/?' + JSON.stringify(join_query)).then(function(data) { 
      
        var period_data = JSON.parse(data);
        console.log(period_data);

        populateTables(period_data, year);

    });

  }

  var renderTables = function() { 

    var monthRef = ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"];

    for(var i=0; i<tables.length; i++) { 

        //Fieldset and table skeleton
        var fieldset_string = '<fieldset id="' + tables[i] + '-budget"><legend>' + tables[i] + '</legend><table class="budget-table"><thead><th>Period</th><th>Actual</th><th>Budget</th></thead><tbody id="' + tables[i] + '-body"></tbody></table></fieldset>';
        var fieldset_data = domConstruct.toDom(fieldset_string);

        domConstruct.place(fieldset_data, dom.byId("units-budgeting-budgetform"));

        //Populate with months - this example is Jan - Dec, can be updated dynamically
        for(var k=0; k<monthRef.length; k++) { 
          var insert_string = "<tr id='" + (tables[i] + "-" + k) + "' class='datarow'><td>" + monthRef[k] +  "</td><td>-</td><td><input value='-' id='"+ (tables[i] + k)+"'></input></td>";
          var insert_data = domConstruct.toDom(insert_string);
          
          domConstruct.place(insert_data, dom.byId(tables[i] + "-body"));
        }

        //Totals
        var agrigate_rows = "<tr class='datarow'><td>Total</td><td>0.00</td><td id='" + tables[i] + "-total'>-</td></tr><tr class='datarow'><td colspan='2'>Annual Budget</td><td><input value='-'></input></td></tr>";
        var agrigate_data = domConstruct.toDom(agrigate_rows);

        domConstruct.place(agrigate_data, dom.byId(tables[i] + "-body"));
    }

  }

   var populateTables = function(period_data, year) { 

      
        //build table here if you want to 
        //render fieldset etc. 
        //personally I think this is gross
        var fieldset_string = '<fieldset id="' + tables[year] + '-budget"><legend>' + tables[year] + '</legend><legend>Year Ended - <span id="' + tables[year] + '-ending"></span></legend><table class="table table-striped"><thead><th>Period</th><th>Actual</th><th>Budget</th></thead><tbody id="' + tables[year] + '-body"></tbody></table></fieldset>';
        var fieldset_data = domConstruct.toDom(fieldset_string);

        domConstruct.place(fieldset_data, dom.byId("units-budgeting-budgetform"));

        var totalBudget=0;
        //period data
        for(var j=0; j<period_data.length; j++) {
          var current_row = period_data[j];

          budgetModel[year][j] = current_row.budget;
          
          budgetModel[year][j] = { 
            account_id : current_row.account_id,
            budget : current_row.budget,
            enterprise_id : current_row.enterprise_id,
            period_id : current_row.period_id
          }

          console.log("Budget Model candidate: ",  budgetModel[year][j]);
          totalBudget += current_row.budget;
          console.log("Data on current period: ", period_data);

          //This is LITERALLY gross
          var uid = current_row.enterprise_id + '/' + current_row.account_id + '/' + current_row.period_id; 

          var insert_string = "<tr id='" + (tables[year] + "-" + uid) + "' class='datarow'><td>" + formatDate(current_row.period_start) + "</td><td>0.00</td><td><input value='" + current_row.budget +"' type='number' min='0.00' step='0.01' id='"+ (tables[year] + j)+"'></input></td>";
          var insert_data = domConstruct.toDom(insert_string);
          domConstruct.place(insert_data, dom.byId(tables[year] + "-body"));
        }

        //Totals
        //
        var agrigate_rows = "<tr class='datarow'><td>Total</td><td>0.00</td><td id='" + tables[year] + "-total'>" + totalBudget + "</td></tr><tr class='datarow'><td colspan='2'>Annual Budget</td><td><input value='0.00'></input></td></tr>";
        var agrigate_data = domConstruct.toDom(agrigate_rows);

        console.log("Collected mode: ", budgetModel);

        domConstruct.place(agrigate_data, dom.byId(tables[year] + "-body"));
        
     }
   //}

   var tableFill = function(index) { 
    //used to align tables if some aren't rendered - this is hacky and should be done with CSS
    var fieldset_string = '<fieldset style="visibility: hidden;" id="' + tables[index] + '-budget"><legend>' + tables[index] + '</legend><legend>Year Ended - <span id="' + tables[index] + '-ending"></span></legend><table class="table table-striped"><thead><th>Period</th><th>Actual</th><th>Budget</th></thead><tbody id="' + tables[index] + '-body"></tbody></table></fieldset>';
    var fieldset_data = domConstruct.toDom(fieldset_string);

    domConstruct.place(fieldset_data, dom.byId("units-budgeting-budgetform"));
   }

   var clearTables = function() { 
      //uses class to determine rows for now
      //for(i=0; i<tables.length; i++) { 
      //query(".datarow").forEach(domConstruct.destroy);
      //}
      for(var i=0; i<tables.length; i++) { 
        //table not rendered with no data in the mdoel
        //if(budgetModel[i].length!=0) { 
          domConstruct.destroy(tables[i] + "-budget");
        //}
      }
   }

   var formatDate = function(dateString) {
      //sfount - This is horrible and I hate my life 
      var monthRef = ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"];
      var date = new Date(dateString);

      return monthRef[date.getMonth()] + " " + date.getFullYear(); 
   }

   var updateModel = function() { 

      //get data from each table 
      for(var i=0; i<tables.length; i++) { 
        //Check for valid fiscal year
        if(budgetModel[i].length!=0) { 
          console.log("Would be updating " + tables[i]);

          var budgetTotal = 0;
          var updateServer = new Array();

          for(var k=0; k<budgetModel[i].length; k++) { 
            var controlValue = domAttr.get(tables[i] + k, "value");
            budgetTotal += Number(controlValue);
            if(budgetModel[i][k].budget != controlValue) { 
              updateServer.push(budgetModel[i][k]);
              budgetModel[i][k].budget = controlValue;
            }            
            //control.get('value');
          }

          console.log(budgetTotal);
          console.log("Before: " + domAttr.get(tables[i] + "-total", "value"));
          domAttr.set(tables[i] + "-total", "innerHTML",  budgetTotal);
          console.log("After: " + domAttr.get(tables[i] + "-total", "value"));
          //Values have been changed, these shoudl be sent to the server
          if(updateServer.length!=0) { 
            console.log("Update the server");

            for(var j=0; j<updateServer.length; j++) { 
              console.log("PUSHING TO SERVER: ", updateServer[j]);
              var u = updateServer[j];

              var table = 'budget';
              var update_obj = { 
                rows : {account_id : u.account_id, enterprise_id : u.enterprise_id, period_id : u.period_id},
                updateInfo : { 
                  'budget' : u.budget
                }
              }

              //request.post (update)

            }

           
          }


          /*
          query("." + tables[i]).forEach(function(item) { 
            console.log("Current item: ",  item);
            var control = dijit.getEnclosingWidget(item);
            console.log(control);
          });*/
        }
      }
   }

   var clearModel = function() { 
    //does this clear the old objects? One hopes so 
    budgetModel = new Array(3);
    for(var i=0; i<budgetModel.length; i++) { 
      budgetModel[i] = new Array();
    }
   }

  //var headers = '<thead><th>Period</th><th>Actual</th><th>Budget</th></thead>';
  //var domhead = domConstruct.toDom(headers);
  //domConstruct.place(domhead, dom.byId("current-fin-year-budget"))

  // only do this after account_select has loaded (API docs)
  



  /*
  var query = {
    'entities' : [
      {t: 'account', c: ['id', 'accountTxt']},
      {t: 'budget', c: ['id', 'period', 'fiscalyear', 'etc..']},
    ]
  };

  request.get('data/'+JSON.stringify(query)).then(function(results) {
    // treat results appropriately and build table in DOM
    console.log("Recieved data: " + results);
  });*/

  //fin

});

</script>

